#!/usr/bin/env bash

## PURPOSE: entrypoint for python setup

# exit if executed directly
[[ "${BASH_SOURCE[0]}" != "${0}" ]] || { echo "ERROR: this file must be sourced from bash"; exit 1; }

[[ "${BASH_SOURCE[0]}" != "${0}" ]] && echo "# ... loading ${BASH_SOURCE[0]}"

[ "$EUID" = 0 ] || SUDO="sudo -EH" PIP_MODE="--user"

[ -z PKG_TYPE ] || . ./bin/setup/bash

PKG_TYPE=${PKG_TYPE:?required}

set -a

PYTHON_MAJOR_VERSION=$1

PYTHON_MAJOR_VERSION=${PYTHON_MAJOR_VERSION:-3}


## REQUIREMENTS: 
# - load OS packages
# - load pip
# - set constants for PYENV


## REF: https://docs.python.org/3/using/cmdline.html#environment-variables
## REF: https://packaging.python.org/tutorials/installing-packages/#requirements-for-installing-packages
## REF: https://packaging.python.org/tutorials/installing-packages/#ensure-you-can-run-python-from-the-command-line
## 

case $PYTHON_MAJOR_VERSION in
	2)
	python2 --version &>/dev/null || ( [ "$PKG_TYPE" = "apt" ] && apt-get update; $SUDO $PKG_TYPE install -y python )
	PY2_VERSION=$(python2 --version 2>&1 | awk '{print $2}')
	pip --version || ( ( [ "$PKG_TYPE" = "apt" ] && apt-get install -y curl ) && curl -ls https://bootstrap.pypa.io/pip/2.7/get-pip.py | python )
	python2 -m pip install --upgrade $PIP_MODE pip setuptools wheel virtualenv
	pip2 --version
	virtualenv -h &>/dev/null && PY2_VENV=available
	;;

	3)
	python3 --version &>/dev/null ||  ( [ "$PKG_TYPE" = "apt" ] && apt-get update; $SUDO $PKG_TYPE install -y python3 python3-pip )
	PY3_VERSION=$(python3 --version 2>&1 | awk '{print $2}')
	pip3 --version
	python3 -m venv -h &>/dev/null && PY3_VENV=available
	;;
	
	4)
	echo "ERROR: not implemented
	: REF: https://opensource.com/life/14/9/why-python-4-wont-be-python-3
	: REF: https://www.reddit.com/r/Python/comments/7zvyhx/pep_563_mentions_python_40_whats_going_on/
	: REF: https://twitter.com/gvanrossum/status/1306082472443084801
	"
	unset PYTHON_MAJOR_VERSION
	;;
	
	*)
	echo "ERROR: not implemented"
	unset PYTHON_MAJOR_VERSION
	;;

esac #PYTHON_MAJOR_VERSION

set +a

echo "## DONE : python setup"
env | grep ^PY

## END 
